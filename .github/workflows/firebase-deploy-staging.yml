name: Build and Deploy Frontend to Firebase Staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy to Firebase Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify deployment started
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'started'
          service: 'Frontend Staging (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Configure Git for SSH dependencies
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://".insteadOf "git://"

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          yarn install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: Setup dynamic environment variables
        run: |
          echo "Setting up dynamic environment variables for staging..."
          chmod +x ./.github/scripts/sync-env-variables.js
          echo "ğŸ”§ Generating staging environment variables..."
          node ./.github/scripts/sync-env-variables.js --branch staging --output-format env-file --clean > .env.production
          echo "âœ… Dynamic environment file created using .env.staging template"
          echo "ğŸ“„ Environment file contents (sensitive values hidden):"
          cat .env.production | sed 's/=.*/=***/' | head -10

      - name: Build application
        run: |
          echo "Building application for staging..."
          yarn build
          echo "âœ… Build completed successfully!"
          echo "Build output:"
          ls -la dist/
          echo "Index file size:"
          du -h dist/index.html

      - name: Install Firebase CLI
        run: |
          echo "Installing Firebase CLI..."
          npm install -g firebase-tools
          echo "âœ… Firebase CLI installed"

      - name: Setup Firebase Service Account
        run: |
          echo "Setting up Firebase service account..."
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY_STAGING }}" | base64 --decode > $HOME/firebase-service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-service-account.json" >> $GITHUB_ENV
          echo "âœ… Service account configured"

      - name: Deploy to Firebase Staging
        run: |
          echo "Deploying to Firebase Staging..."
          firebase deploy --only hosting --project ludora-staging
          echo "âœ… Deployment completed successfully!"
          echo "Frontend staging deployed to: https://staging.ludora.app"
          echo "Also available at: https://ludora-staging.web.app"

      - name: Deployment summary
        run: |
          echo "ğŸš€ Frontend staging deployment completed successfully!"
          echo "Live URL: https://staging.ludora.app"
          echo "Fallback URL: https://ludora-staging.web.app"
          echo "Firebase Console: https://console.firebase.google.com/project/ludora-staging"

      - name: Notify deployment success
        if: success()
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'success'
          service: 'Frontend Staging (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            ğŸŒ Live URL: https://staging.ludora.app
            ğŸ”— Fallback URL: https://ludora-staging.web.app
            ğŸ“Š Firebase Console: https://console.firebase.google.com/project/ludora-staging
            ğŸ“¦ Firebase Hosting: https://ludora-staging.firebaseapp.com

      - name: Notify deployment failure
        if: failure()
        uses: ./.github/actions/telegram-notify
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'failed'
          service: 'Frontend Staging (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            âš ï¸ ×©×œ×‘ ×›×•×©×œ: ${{ job.status }}
            ğŸ” ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×œ×¤×¨×˜×™× × ×•×¡×¤×™×