name: Build and Deploy Frontend to Firebase Staging

on:
  push:
    branches:
      - staging
  pull_request:
    branches:
      - staging
    types: [closed]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy to Firebase Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout ludora-utils
        uses: actions/checkout@v4
        with:
          repository: omriozer/ludora-utils
          path: ludora-utils
          fetch-depth: 0

      - name: Setup workspace
        run: |
          echo "Current directory structure:"
          pwd
          ls -la
          echo "Moving ludora-utils to parent directory for package.json dependency:"
          mv ludora-utils ../ludora-utils
          echo "Parent directory:"
          ls -la ../
          echo "Ludora-utils check:"
          ls -la ../ludora-utils/ || echo "ludora-utils not found"

      - name: Get commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify deployment started
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'started'
          service: 'Frontend Staging (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Configure Git for SSH dependencies
        run: |
          echo "ğŸ”§ Configuring Git to use HTTPS instead of SSH..."
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://".insteadOf "git://"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          echo "ğŸ“‹ Current Git URL configuration:"
          git config --global --list | grep url || true
          echo "âœ… Git configuration complete"

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          yarn install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: Setup dynamic environment variables
        run: |
          echo "Setting up dynamic environment variables for staging..."
          echo "ğŸ”§ Creating .env.staging.local file for staging deployment from GitHub Secrets..."
          cat > .env.staging.local << EOF
          # Generated .env file for staging environment
          # Generated at: $(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")

          VITE_API_BASE=${{ secrets.VITE_API_BASE_STAGING }}
          VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY_STAGING }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_STAGING }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID_STAGING }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_STAGING }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_STAGING }}
          VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID_STAGING }}
          VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_STAGING }}
          EOF
          echo "âœ… Dynamic environment file created for staging deployment"
          echo "ğŸ“„ Environment file contents (sensitive values hidden):"
          cat .env.staging.local | sed 's/=.*/=***/' | head -10

      - name: Build application
        run: |
          echo "Building application for staging..."
          yarn build:staging
          echo "âœ… Build completed successfully!"
          echo "Build output:"
          ls -la dist/
          echo "Index file size:"
          du -h dist/index.html

      - name: Install Firebase CLI
        run: |
          echo "Installing Firebase CLI..."
          npm install -g firebase-tools
          echo "âœ… Firebase CLI installed"

      - name: Setup Firebase Service Account
        run: |
          echo "Setting up Firebase service account..."
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY_STAGING }}" | base64 --decode > $HOME/firebase-service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-service-account.json" >> $GITHUB_ENV
          echo "âœ… Service account configured"

      - name: Deploy to Firebase Staging
        run: |
          echo "Deploying to Firebase Staging..."
          echo "ğŸ” Authenticating with Firebase using service account..."
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-service-account.json
          echo "ğŸ“‹ Verifying service account file exists:"
          ls -la $HOME/firebase-service-account.json
          echo "ğŸ”§ Setting Firebase project..."
          firebase use ludora-staging
          echo "ğŸ“‹ Current Firebase project:"
          firebase projects:list
          echo "ğŸš€ Starting deployment..."
          firebase deploy --only hosting --project ludora-staging --non-interactive
          echo "âœ… Deployment completed successfully!"
          echo "Frontend staging deployed to: https://staging.ludora.app"
          echo "Also available at: https://ludora-staging.web.app"

      - name: Deployment summary
        run: |
          echo "ğŸš€ Frontend staging deployment completed successfully!"
          echo "Live URL: https://staging.ludora.app"
          echo "Fallback URL: https://ludora-staging.web.app"
          echo "Firebase Console: https://console.firebase.google.com/project/ludora-staging"

      - name: Notify deployment success
        if: success()
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'success'
          service: 'Frontend Staging (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            ğŸŒ Live URL: https://staging.ludora.app
            ğŸ”— Fallback URL: https://ludora-staging.web.app
            ğŸ“Š Firebase Console: https://console.firebase.google.com/project/ludora-staging
            ğŸ“¦ Firebase Hosting: https://ludora-staging.firebaseapp.com

      - name: Notify deployment failure
        if: failure()
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'failed'
          service: 'Frontend Staging (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            âš ï¸ ×©×œ×‘ ×›×•×©×œ: ${{ job.status }}
            ğŸ” ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×œ×¤×¨×˜×™× × ×•×¡×¤×™×