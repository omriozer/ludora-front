name: Build and Deploy Frontend to Firebase

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy to Firebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify deployment started
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'started'
          service: 'Frontend (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Configure Git for SSH dependencies
        run: |
          echo "ğŸ”§ Configuring Git to use HTTPS instead of SSH..."
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://".insteadOf "git://"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          echo "ğŸ“‹ Current Git URL configuration:"
          git config --global --list | grep url || true
          echo "âœ… Git configuration complete"

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          yarn install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: Setup dynamic environment variables
        run: |
          echo "Setting up dynamic environment variables for production..."
          echo "ğŸ”§ Creating .env.production file for production deployment from GitHub Secrets..."
          cat > .env.production << EOF
          # Generated .env file for production environment
          # Generated at: $(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")

          VITE_API_BASE=${{ secrets.VITE_API_BASE }}
          VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          EOF
          echo "âœ… Dynamic environment file created for production deployment"
          echo "ğŸ“„ Environment file contents (sensitive values hidden):"
          cat .env.production | sed 's/=.*/=***/' | head -10

      - name: Build application
        run: |
          echo "Building application..."
          yarn build
          echo "âœ… Build completed successfully!"
          echo "Build output:"
          ls -la dist/
          echo "Index file size:"
          du -h dist/index.html

      - name: Install Firebase CLI
        run: |
          echo "Installing Firebase CLI..."
          npm install -g firebase-tools
          echo "âœ… Firebase CLI installed"

      - name: Setup Firebase Service Account
        run: |
          echo "Setting up Firebase service account..."
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}" | base64 --decode > $HOME/firebase-service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-service-account.json" >> $GITHUB_ENV
          echo "âœ… Service account configured"

      - name: Deploy to Firebase
        run: |
          echo "Deploying to Firebase..."
          firebase deploy --only hosting --project ludora-af706
          echo "âœ… Deployment completed successfully!"
          echo "Frontend deployed to: https://ludora.app"

      - name: Deployment summary
        run: |
          echo "ğŸš€ Frontend deployment completed successfully!"
          echo "Live URL: https://ludora.app"
          echo "Firebase Console: https://console.firebase.google.com/project/ludora-af706"

      - name: Notify deployment success
        if: success()
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'success'
          service: 'Frontend (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            ğŸŒ Live URL: https://ludora.app
            ğŸ”— Firebase Console: https://console.firebase.google.com/project/ludora-af706
            ğŸ“¦ Firebase Hosting: https://ludora-af706.web.app

      - name: Notify deployment failure
        if: failure()
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'failed'
          service: 'Frontend (Firebase)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            âš ï¸ ×©×œ×‘ ×›×•×©×œ: ${{ job.status }}
            ğŸ” ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×œ×¤×¨×˜×™× × ×•×¡×¤×™×