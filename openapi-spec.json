{
  "openapi": "3.1.0",
  "info": {
    "title": "Ludora Educational Platform API",
    "version": "1.0.0",
    "description": "Comprehensive API for the Ludora educational platform with polymorphic products and access control"
  },
  "servers": [
    {
      "url": "http://localhost:3000/api",
      "description": "Development"
    }
  ],
  "components": {
    "securitySchemes": {
      "cookieAuth": {
        "type": "apiKey",
        "in": "cookie",
        "name": "auth_token"
      },
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer"
      }
    },
    "schemas": {
      "RegisterRequest": {
        "type": "object",
        "required": [
          "email",
          "password"
        ],
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "example": "teacher@example.com"
          },
          "password": {
            "type": "string",
            "minLength": 6,
            "example": "securepassword123"
          },
          "fullName": {
            "type": "string",
            "example": "Sarah Cohen"
          },
          "phone": {
            "type": "string",
            "example": "+972501234567"
          }
        }
      },
      "FirebaseLoginRequest": {
        "type": "object",
        "required": [
          "idToken"
        ],
        "properties": {
          "idToken": {
            "type": "string",
            "description": "Firebase ID token from frontend authentication",
            "example": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjE..."
          }
        }
      },
      "StudentAccessRequest": {
        "type": "object",
        "properties": {
          "lobby_code": {
            "type": "string",
            "pattern": "^[A-Z0-9]{6}$",
            "example": "ABC123",
            "description": "Game lobby code for student access"
          },
          "session_id": {
            "type": "string",
            "example": "session_xyz789",
            "description": "Game session ID for student access"
          },
          "teacher_invitation_code": {
            "type": "string",
            "pattern": "^[A-Z0-9]{6}$",
            "example": "DEF456",
            "description": "Teacher invitation code for linking student to teacher"
          }
        },
        "description": "Student portal access request (one of lobby_code, session_id, or teacher_invitation_code required)"
      },
      "AuthResponse": {
        "type": "object",
        "required": [
          "user",
          "session"
        ],
        "properties": {
          "user": {
            "$ref": "#/components/schemas/User"
          },
          "session": {
            "type": "object",
            "properties": {
              "sessionId": {
                "type": "string",
                "example": "session_abc123"
              },
              "expiresAt": {
                "type": "string",
                "format": "date-time",
                "example": "2025-01-16T10:00:00Z"
              }
            }
          },
          "message": {
            "type": "string",
            "example": "Login successful"
          }
        }
      },
      "StudentPortalAuthResponse": {
        "type": "object",
        "required": [
          "accessType",
          "sessionContext"
        ],
        "properties": {
          "accessType": {
            "type": "string",
            "enum": [
              "lobby_access",
              "session_access",
              "teacher_invite",
              "authenticated"
            ],
            "description": "Type of student portal access granted"
          },
          "sessionContext": {
            "type": "object",
            "description": "Context-specific data for the access type"
          },
          "user": {
            "$ref": "#/components/schemas/User",
            "nullable": true,
            "description": "User object if authenticated, null for anonymous access"
          }
        }
      },
      "TeacherInviteLinkRequest": {
        "type": "object",
        "required": [
          "teacher_invitation_code"
        ],
        "properties": {
          "teacher_invitation_code": {
            "type": "string",
            "pattern": "^[A-Z0-9]{6}$",
            "example": "ABC123",
            "description": "Teacher invitation code to link student account"
          }
        }
      },
      "TeacherInviteLinkResponse": {
        "type": "object",
        "required": [
          "success",
          "message"
        ],
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "message": {
            "type": "string",
            "example": "Successfully linked to teacher"
          },
          "teacher": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string"
              },
              "full_name": {
                "type": "string"
              }
            }
          },
          "consent_created": {
            "type": "boolean",
            "description": "Whether parent consent was created during linking"
          }
        }
      },
      "RefreshTokenRequest": {
        "type": "object",
        "required": [
          "refresh_token"
        ],
        "properties": {
          "refresh_token": {
            "type": "string",
            "example": "refresh_abc123xyz",
            "description": "Refresh token for obtaining new access token"
          }
        }
      },
      "RefreshTokenResponse": {
        "type": "object",
        "required": [
          "access_token",
          "expires_in"
        ],
        "properties": {
          "access_token": {
            "type": "string",
            "description": "New JWT access token"
          },
          "expires_in": {
            "type": "integer",
            "example": 3600,
            "description": "Token expiration time in seconds"
          },
          "refresh_token": {
            "type": "string",
            "nullable": true,
            "description": "New refresh token (optional, returned if rotation is enabled)"
          }
        }
      },
      "LogoutResponse": {
        "type": "object",
        "required": [
          "success",
          "message"
        ],
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "message": {
            "type": "string",
            "example": "Logged out successfully"
          }
        }
      },
      "SessionValidationResponse": {
        "type": "object",
        "required": [
          "valid",
          "user"
        ],
        "properties": {
          "valid": {
            "type": "boolean",
            "example": true,
            "description": "Whether the session is valid"
          },
          "user": {
            "$ref": "#/components/schemas/User",
            "nullable": true,
            "description": "User object if session is valid"
          },
          "expiresAt": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "example": "2025-01-16T10:00:00Z"
          }
        }
      },
      "User": {
        "type": "object",
        "required": [
          "id",
          "email",
          "role"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "user_abc123"
          },
          "email": {
            "type": "string",
            "format": "email",
            "example": "teacher@example.com"
          },
          "role": {
            "type": "string",
            "enum": [
              "student",
              "teacher",
              "admin"
            ],
            "example": "teacher"
          },
          "first_name": {
            "type": "string",
            "example": "Sarah"
          },
          "last_name": {
            "type": "string",
            "example": "Cohen"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "example": "2025-01-15T10:00:00Z"
          }
        }
      },
      "AccessControlResponse": {
        "type": "object",
        "required": [
          "hasAccess",
          "accessType",
          "canDownload",
          "canPreview",
          "canPlay",
          "remainingAllowances"
        ],
        "properties": {
          "hasAccess": {
            "type": "boolean",
            "description": "Whether user can access this content",
            "example": true
          },
          "accessType": {
            "type": "string",
            "enum": [
              "creator",
              "purchase",
              "subscription_claim",
              "student_via_teacher",
              "none"
            ],
            "description": "How the user gained access",
            "example": "purchase"
          },
          "canDownload": {
            "type": "boolean",
            "description": "Whether user can download content files",
            "example": true
          },
          "canPreview": {
            "type": "boolean",
            "description": "Whether user can see preview/demo",
            "example": true
          },
          "canPlay": {
            "type": "boolean",
            "description": "Whether user can play/use the content",
            "example": true
          },
          "remainingAllowances": {
            "oneOf": [
              {
                "type": "number",
                "minimum": 0
              },
              {
                "type": "string",
                "enum": [
                  "unlimited"
                ]
              }
            ],
            "description": "How many uses remaining (or 'unlimited')",
            "example": "unlimited"
          },
          "expiresAt": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "When access expires (null = never expires)",
            "example": null
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "required": [
          "error",
          "message"
        ],
        "properties": {
          "error": {
            "type": "string",
            "example": "PRODUCT_NOT_FOUND"
          },
          "message": {
            "type": "string",
            "example": "Product with ID 'game_123' was not found"
          },
          "details": {
            "type": "object",
            "description": "Additional error context"
          }
        }
      },
      "EntityListResponse": {
        "type": "object",
        "required": [
          "data",
          "pagination"
        ],
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "type": "object"
            },
            "description": "Array of entity objects (type varies by entity type)"
          },
          "pagination": {
            "type": "object",
            "properties": {
              "total": {
                "type": "integer",
                "example": 150,
                "description": "Total number of entities"
              },
              "page": {
                "type": "integer",
                "example": 1,
                "description": "Current page number"
              },
              "limit": {
                "type": "integer",
                "example": 50,
                "description": "Number of items per page"
              },
              "pages": {
                "type": "integer",
                "example": 3,
                "description": "Total number of pages"
              }
            }
          }
        }
      },
      "EntityCreateRequest": {
        "type": "object",
        "description": "Entity creation request (schema varies by entity type)",
        "properties": {
          "title": {
            "type": "string",
            "example": "My New Entity"
          },
          "description": {
            "type": "string",
            "nullable": true,
            "example": "A detailed description"
          }
        },
        "additionalProperties": true
      },
      "EntityUpdateRequest": {
        "type": "object",
        "description": "Entity update request (partial schema, varies by entity type)",
        "additionalProperties": true
      },
      "EntityBulkRequest": {
        "type": "object",
        "required": [
          "operation",
          "data"
        ],
        "properties": {
          "operation": {
            "type": "string",
            "enum": [
              "create",
              "update",
              "delete"
            ],
            "example": "create",
            "description": "Bulk operation type"
          },
          "data": {
            "type": "array",
            "items": {
              "type": "object"
            },
            "minItems": 1,
            "maxItems": 100,
            "description": "Array of entities to operate on (max 100)"
          }
        }
      },
      "EntityBulkResponse": {
        "type": "object",
        "required": [
          "success",
          "results"
        ],
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "results": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "status": {
                  "type": "string",
                  "enum": [
                    "success",
                    "error"
                  ]
                },
                "error": {
                  "type": "string",
                  "nullable": true
                }
              }
            }
          },
          "total": {
            "type": "integer",
            "example": 50,
            "description": "Total operations attempted"
          },
          "successful": {
            "type": "integer",
            "example": 48,
            "description": "Number of successful operations"
          },
          "failed": {
            "type": "integer",
            "example": 2,
            "description": "Number of failed operations"
          }
        }
      },
      "ProductBase": {
        "type": "object",
        "required": [
          "id",
          "product_type",
          "title",
          "price",
          "creator_user_id",
          "entity_id",
          "is_published"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "product_abc123",
            "description": "Unique product identifier"
          },
          "product_type": {
            "type": "string",
            "enum": [
              "file",
              "lesson_plan",
              "game",
              "workshop",
              "course",
              "tool",
              "bundle"
            ],
            "description": "Product type discriminator"
          },
          "title": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "example": "Advanced Memory Game",
            "description": "Product title"
          },
          "short_description": {
            "type": "string",
            "nullable": true,
            "maxLength": 500,
            "example": "Quick summary of the product",
            "description": "Short product description"
          },
          "description": {
            "type": "string",
            "nullable": true,
            "example": "A challenging memory game for students with rich HTML formatting",
            "description": "Full product description (supports rich text HTML)"
          },
          "category": {
            "type": "string",
            "nullable": true,
            "example": "educational-games",
            "description": "Product category"
          },
          "price": {
            "type": "number",
            "minimum": 0,
            "example": 49.9,
            "description": "Product price in ILS"
          },
          "is_published": {
            "type": "boolean",
            "example": true,
            "description": "Whether product is published and visible to buyers"
          },
          "image_filename": {
            "type": "string",
            "nullable": true,
            "example": "product-image.jpg",
            "description": "Product image filename"
          },
          "has_image": {
            "type": "boolean",
            "default": false,
            "description": "Whether product has an image asset"
          },
          "marketing_video_type": {
            "type": "string",
            "enum": [
              "youtube",
              "uploaded"
            ],
            "nullable": true,
            "description": "Type of marketing video"
          },
          "marketing_video_id": {
            "type": "string",
            "nullable": true,
            "example": "dQw4w9WgXcQ",
            "description": "YouTube video ID or entity ID for uploaded videos"
          },
          "marketing_video_title": {
            "type": "string",
            "nullable": true,
            "example": "Product Demo Video"
          },
          "marketing_video_duration": {
            "type": "integer",
            "nullable": true,
            "example": 180,
            "description": "Video duration in seconds"
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "default": [],
            "example": [
              "math",
              "elementary",
              "interactive"
            ],
            "description": "Product tags for searchability"
          },
          "target_audience": {
            "type": "string",
            "nullable": true,
            "example": "Elementary students",
            "description": "Target audience description"
          },
          "type_attributes": {
            "type": "object",
            "nullable": true,
            "description": "Type-specific attributes (JSONB field)"
          },
          "access_days": {
            "type": "number",
            "nullable": true,
            "example": 365,
            "description": "Access duration in days (null = lifetime access)"
          },
          "creator_user_id": {
            "type": "string",
            "example": "user_teacher123",
            "description": "ID of the user who created this product"
          },
          "entity_id": {
            "type": "string",
            "example": "game_abc123",
            "description": "ID of the associated entity record (null for bundles)"
          },
          "content_topic_id": {
            "type": "string",
            "nullable": true,
            "example": "topic_mathematics",
            "description": "Associated content topic"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "example": "2025-01-15T10:00:00Z"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "example": "2025-01-15T14:30:00Z"
          }
        }
      },
      "GameEntity": {
        "type": "object",
        "required": [
          "id",
          "game_type",
          "digital",
          "game_settings"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "game_abc123",
            "description": "Unique game identifier"
          },
          "game_type": {
            "type": "string",
            "enum": [
              "scatter_game",
              "sharp_and_smooth",
              "memory_game",
              "ar_up_there"
            ],
            "nullable": true,
            "example": "memory_game",
            "description": "Type of game"
          },
          "digital": {
            "type": "boolean",
            "default": true,
            "example": true,
            "description": "true = דיגיטלי, false = גרסה להדפסה"
          },
          "game_settings": {
            "type": "object",
            "description": "Game-specific settings (JSONB)",
            "example": {
              "difficulty": "medium",
              "time_limit": 60,
              "cards_count": 12
            }
          },
          "content_query": {
            "type": "object",
            "nullable": true,
            "description": "JSON object defining how to query content for this game"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "FileEntity": {
        "type": "object",
        "required": [
          "id",
          "title",
          "allow_preview",
          "add_branding",
          "is_asset_only"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "file_abc123",
            "description": "Unique file identifier"
          },
          "title": {
            "type": "string",
            "example": "Worksheet: Math Practice"
          },
          "file_name": {
            "type": "string",
            "nullable": true,
            "example": "math-worksheet.pdf",
            "description": "Original filename (NULL if not uploaded yet)"
          },
          "file_type": {
            "type": "string",
            "enum": [
              "pdf",
              "ppt",
              "docx",
              "zip",
              "other"
            ],
            "nullable": true,
            "example": "pdf"
          },
          "allow_preview": {
            "type": "boolean",
            "default": true,
            "description": "Whether file can be previewed"
          },
          "add_branding": {
            "type": "boolean",
            "default": true,
            "description": "Whether branding is enabled"
          },
          "branding_settings": {
            "type": "object",
            "nullable": true,
            "description": "File-specific branding settings (JSONB)"
          },
          "branding_template_id": {
            "type": "string",
            "nullable": true,
            "description": "Reference to system_templates for branding"
          },
          "accessible_pages": {
            "type": "array",
            "items": {
              "type": "integer",
              "minimum": 1
            },
            "nullable": true,
            "example": [
              1,
              3,
              5,
              7
            ],
            "description": "Page numbers accessible in preview (null = all pages)"
          },
          "watermark_template_id": {
            "type": "string",
            "nullable": true,
            "description": "Reference to system_templates for watermarks"
          },
          "watermark_settings": {
            "type": "object",
            "nullable": true,
            "description": "Custom watermark settings (JSONB)"
          },
          "is_asset_only": {
            "type": "boolean",
            "default": false,
            "description": "true = asset only (not standalone product)"
          },
          "target_format": {
            "type": "string",
            "enum": [
              "pdf-a4-portrait",
              "pdf-a4-landscape",
              "svg-lessonplan",
              "unknown"
            ],
            "nullable": true,
            "example": "pdf-a4-portrait",
            "description": "File format orientation"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "LessonPlanEntity": {
        "type": "object",
        "required": [
          "id",
          "is_active",
          "allow_slide_preview",
          "add_branding"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "lessonplan_abc123"
          },
          "context": {
            "type": "string",
            "nullable": true,
            "maxLength": 100,
            "example": "hanukkah",
            "description": "Theme context like animals, hanukkah, christmas, etc."
          },
          "file_configs": {
            "type": "object",
            "nullable": true,
            "description": "JSON configuration for files (roles, connections, slide configs)",
            "example": {
              "files": [],
              "presentation": []
            }
          },
          "is_active": {
            "type": "boolean",
            "default": true,
            "description": "Whether lesson plan is active/published"
          },
          "estimated_duration": {
            "type": "integer",
            "nullable": true,
            "example": 45,
            "description": "Estimated duration in minutes"
          },
          "total_slides": {
            "type": "integer",
            "nullable": true,
            "example": 12,
            "description": "Total number of slides"
          },
          "teacher_notes": {
            "type": "string",
            "nullable": true,
            "description": "Notes and instructions for the teacher"
          },
          "accessible_slides": {
            "type": "array",
            "items": {
              "type": "integer",
              "minimum": 0
            },
            "nullable": true,
            "example": [
              0,
              2,
              4
            ],
            "description": "Slide indices accessible in preview (0-based, null = all)"
          },
          "allow_slide_preview": {
            "type": "boolean",
            "default": true,
            "description": "Whether slides can be previewed without purchase"
          },
          "watermark_template_id": {
            "type": "string",
            "nullable": true,
            "description": "Reference to watermark template for slides"
          },
          "branding_template_id": {
            "type": "string",
            "nullable": true,
            "description": "Reference to branding template for slides"
          },
          "branding_settings": {
            "type": "object",
            "nullable": true,
            "description": "Custom branding configuration (JSONB)"
          },
          "add_branding": {
            "type": "boolean",
            "default": true,
            "description": "Whether branding is enabled"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "BundleProduct": {
        "allOf": [
          {
            "$ref": "#/components/schemas/ProductBase"
          },
          {
            "type": "object",
            "required": [
              "type_attributes"
            ],
            "properties": {
              "entity_id": {
                "type": "string",
                "nullable": true,
                "description": "Always null for bundles (no entity table)"
              },
              "type_attributes": {
                "type": "object",
                "required": [
                  "is_bundle",
                  "bundle_items"
                ],
                "properties": {
                  "is_bundle": {
                    "type": "boolean",
                    "enum": [
                      true
                    ],
                    "description": "Must be true for bundle products"
                  },
                  "bundle_items": {
                    "type": "array",
                    "minItems": 2,
                    "maxItems": 50,
                    "items": {
                      "type": "object",
                      "required": [
                        "product_type",
                        "product_id"
                      ],
                      "properties": {
                        "product_type": {
                          "type": "string",
                          "enum": [
                            "file",
                            "lesson_plan",
                            "game",
                            "workshop",
                            "course",
                            "tool"
                          ],
                          "description": "Type of bundled product"
                        },
                        "product_id": {
                          "type": "string",
                          "description": "ID of the bundled product"
                        }
                      }
                    },
                    "description": "Array of bundled products (min 2, max 50)"
                  },
                  "original_total_price": {
                    "type": "number",
                    "minimum": 0,
                    "example": 450,
                    "description": "Sum of individual product prices"
                  },
                  "savings": {
                    "type": "number",
                    "minimum": 0,
                    "example": 150,
                    "description": "Total savings amount"
                  },
                  "savings_percentage": {
                    "type": "number",
                    "minimum": 5,
                    "maximum": 100,
                    "example": 33,
                    "description": "Savings as percentage (min 5%)"
                  }
                }
              }
            }
          }
        ]
      },
      "ProductWithAccess": {
        "allOf": [
          {
            "$ref": "#/components/schemas/ProductBase"
          },
          {
            "type": "object",
            "properties": {
              "access": {
                "$ref": "#/components/schemas/AccessControlResponse"
              },
              "entity": {
                "oneOf": [
                  {
                    "$ref": "#/components/schemas/GameEntity"
                  },
                  {
                    "$ref": "#/components/schemas/FileEntity"
                  },
                  {
                    "$ref": "#/components/schemas/LessonPlanEntity"
                  }
                ],
                "discriminator": {
                  "propertyName": "product_type",
                  "mapping": {
                    "game": "#/components/schemas/GameEntity",
                    "file": "#/components/schemas/FileEntity",
                    "lesson_plan": "#/components/schemas/LessonPlanEntity"
                  }
                },
                "nullable": true,
                "description": "Associated entity data (null for bundles)"
              }
            }
          }
        ]
      },
      "ProductListResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ProductWithAccess"
            }
          },
          "pagination": {
            "type": "object",
            "properties": {
              "total": {
                "type": "integer",
                "example": 150
              },
              "page": {
                "type": "integer",
                "example": 1
              },
              "limit": {
                "type": "integer",
                "example": 50
              },
              "totalPages": {
                "type": "integer",
                "example": 3
              }
            }
          }
        }
      },
      "CreateProductRequest": {
        "type": "object",
        "required": [
          "product_type",
          "title",
          "price"
        ],
        "properties": {
          "product_type": {
            "type": "string",
            "enum": [
              "file",
              "lesson_plan",
              "game",
              "workshop",
              "course",
              "tool",
              "bundle"
            ]
          },
          "title": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200
          },
          "short_description": {
            "type": "string",
            "maxLength": 500
          },
          "description": {
            "type": "string"
          },
          "category": {
            "type": "string"
          },
          "price": {
            "type": "number",
            "minimum": 0
          },
          "is_published": {
            "type": "boolean",
            "default": false
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "target_audience": {
            "type": "string"
          },
          "type_attributes": {
            "type": "object",
            "description": "Type-specific attributes (required for bundles)"
          },
          "access_days": {
            "type": "number",
            "nullable": true
          },
          "content_topic_id": {
            "type": "string"
          }
        }
      },
      "UpdateProductRequest": {
        "type": "object",
        "properties": {
          "title": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200
          },
          "short_description": {
            "type": "string",
            "maxLength": 500
          },
          "description": {
            "type": "string"
          },
          "category": {
            "type": "string"
          },
          "price": {
            "type": "number",
            "minimum": 0
          },
          "is_published": {
            "type": "boolean"
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "target_audience": {
            "type": "string"
          },
          "type_attributes": {
            "type": "object"
          },
          "access_days": {
            "type": "number",
            "nullable": true
          },
          "content_topic_id": {
            "type": "string"
          }
        }
      },
      "SubscriptionBenefits": {
        "type": "object",
        "description": "Rich JSONB benefits structure with granular access control",
        "properties": {
          "games_access": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean",
                "example": true
              },
              "unlimited": {
                "type": "boolean",
                "example": false
              },
              "monthly_limit": {
                "type": "integer",
                "minimum": 0,
                "example": 50,
                "description": "Monthly limit for game claims (ignored if unlimited=true)"
              }
            }
          },
          "files_access": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean",
                "example": true
              },
              "unlimited": {
                "type": "boolean",
                "example": true
              },
              "monthly_limit": {
                "type": "integer",
                "minimum": 0,
                "example": 0,
                "description": "Monthly limit (0 if unlimited=true)"
              }
            }
          },
          "lesson_plans_access": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean",
                "example": true
              },
              "unlimited": {
                "type": "boolean",
                "example": false
              },
              "monthly_limit": {
                "type": "integer",
                "minimum": 0,
                "example": 30
              }
            }
          },
          "workshops_access": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean",
                "example": false
              },
              "unlimited": {
                "type": "boolean",
                "example": false
              },
              "monthly_limit": {
                "type": "integer",
                "minimum": 0,
                "example": 0
              }
            }
          },
          "courses_access": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean",
                "example": false
              },
              "unlimited": {
                "type": "boolean",
                "example": false
              },
              "monthly_limit": {
                "type": "integer",
                "minimum": 0,
                "example": 0
              }
            }
          },
          "tools_access": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean",
                "example": false
              },
              "unlimited": {
                "type": "boolean",
                "example": false
              },
              "monthly_limit": {
                "type": "integer",
                "minimum": 0,
                "example": 0
              }
            }
          },
          "classroom_management": {
            "type": "object",
            "properties": {
              "enabled": {
                "type": "boolean",
                "example": true
              },
              "unlimited_classrooms": {
                "type": "boolean",
                "example": false
              },
              "max_classrooms": {
                "type": "integer",
                "minimum": 0,
                "example": 10
              },
              "max_total_students": {
                "type": "integer",
                "minimum": 0,
                "example": 500
              }
            }
          },
          "reports_access": {
            "type": "boolean",
            "example": true,
            "description": "Whether user can access reports and analytics"
          }
        }
      },
      "SubscriptionPlan": {
        "type": "object",
        "required": [
          "id",
          "name",
          "price",
          "billing_period",
          "benefits",
          "is_active"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "plan_premium_monthly",
            "description": "Unique subscription plan identifier"
          },
          "name": {
            "type": "string",
            "example": "Premium Monthly",
            "description": "Subscription plan name"
          },
          "description": {
            "type": "string",
            "nullable": true,
            "example": "Full access to all educational content",
            "description": "Plan description"
          },
          "price": {
            "type": "number",
            "minimum": 0,
            "example": 99.9,
            "description": "Base price in ILS before discounts"
          },
          "billing_period": {
            "type": "string",
            "enum": [
              "daily",
              "monthly",
              "yearly"
            ],
            "example": "monthly",
            "description": "Billing frequency (daily only in staging/dev)"
          },
          "has_discount": {
            "type": "boolean",
            "nullable": true,
            "example": true,
            "description": "Whether plan has an active discount"
          },
          "discount_type": {
            "type": "string",
            "enum": [
              "percentage",
              "fixed"
            ],
            "nullable": true,
            "example": "percentage",
            "description": "Type of discount applied"
          },
          "discount_value": {
            "type": "number",
            "nullable": true,
            "example": 20,
            "description": "Discount value (percentage or fixed amount)"
          },
          "discount_valid_until": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "example": "2025-12-31T23:59:59Z",
            "description": "Discount expiration date"
          },
          "is_active": {
            "type": "boolean",
            "example": true,
            "description": "Whether plan is available for purchase"
          },
          "is_default": {
            "type": "boolean",
            "nullable": true,
            "example": false,
            "description": "Whether this is the default plan"
          },
          "plan_type": {
            "type": "string",
            "enum": [
              "free",
              "pro"
            ],
            "nullable": true,
            "example": "pro",
            "description": "Plan tier type"
          },
          "benefits": {
            "$ref": "#/components/schemas/SubscriptionBenefits"
          },
          "sort_order": {
            "type": "number",
            "nullable": true,
            "example": 1,
            "description": "Display order for plan listing"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Subscription": {
        "type": "object",
        "required": [
          "id",
          "user_id",
          "subscription_plan_id",
          "status",
          "billing_price",
          "billing_period",
          "start_date"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "sub_abc123",
            "description": "Unique subscription identifier"
          },
          "user_id": {
            "type": "string",
            "example": "user_teacher456",
            "description": "ID of subscribed user"
          },
          "subscription_plan_id": {
            "type": "string",
            "example": "plan_premium_monthly",
            "description": "Associated subscription plan"
          },
          "transaction_id": {
            "type": "string",
            "nullable": true,
            "example": "txn_xyz789",
            "description": "Associated transaction for payment tracking"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "active",
              "cancelled",
              "expired",
              "failed"
            ],
            "example": "active",
            "description": "Current subscription status"
          },
          "start_date": {
            "type": "string",
            "format": "date-time",
            "example": "2025-01-15T10:00:00Z",
            "description": "Subscription start date"
          },
          "end_date": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "example": null,
            "description": "Fixed end date (null for auto-renewing)"
          },
          "next_billing_date": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "example": "2025-02-15T00:00:00Z",
            "description": "Next billing date for auto-renewal"
          },
          "cancelled_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "example": null,
            "description": "Cancellation timestamp"
          },
          "payplus_subscription_uid": {
            "type": "string",
            "format": "uuid",
            "nullable": true,
            "example": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            "description": "PayPlus recurring subscription identifier"
          },
          "payplus_status": {
            "type": "string",
            "enum": [
              "active",
              "cancelled",
              "expired",
              "failed",
              "pending",
              "suspended"
            ],
            "nullable": true,
            "example": "active",
            "description": "PayPlus-reported subscription status"
          },
          "billing_price": {
            "type": "number",
            "minimum": 0,
            "maximum": 99999.99,
            "example": 79.9,
            "description": "Actual billing amount (after discounts, can be admin-overridden)"
          },
          "original_price": {
            "type": "number",
            "nullable": true,
            "example": 99.9,
            "description": "Original price before discounts"
          },
          "discount_amount": {
            "type": "number",
            "nullable": true,
            "example": 20,
            "description": "Discount amount applied"
          },
          "billing_period": {
            "type": "string",
            "enum": [
              "daily",
              "monthly",
              "yearly"
            ],
            "example": "monthly",
            "description": "Billing frequency (daily only in staging/dev)"
          },
          "metadata": {
            "type": "object",
            "nullable": true,
            "description": "Additional metadata (JSONB)"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "CreateSubscriptionRequest": {
        "type": "object",
        "required": [
          "subscription_plan_id"
        ],
        "properties": {
          "subscription_plan_id": {
            "type": "string",
            "example": "plan_premium_monthly"
          },
          "billing_price": {
            "type": "number",
            "minimum": 0,
            "description": "Admin override for billing price (optional)"
          },
          "start_date": {
            "type": "string",
            "format": "date-time",
            "description": "Custom start date (admin only)"
          },
          "enableAutoRenewal": {
            "type": "boolean",
            "default": true,
            "description": "Whether to enable auto-renewal"
          }
        }
      },
      "UpdateSubscriptionRequest": {
        "type": "object",
        "properties": {
          "billing_price": {
            "type": "number",
            "minimum": 0,
            "description": "Update billing price (admin only)"
          },
          "next_billing_date": {
            "type": "string",
            "format": "date-time",
            "description": "Update next billing date"
          },
          "end_date": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "Set/update fixed end date"
          }
        }
      },
      "CancelSubscriptionRequest": {
        "type": "object",
        "properties": {
          "keepActiveUntilEndDate": {
            "type": "boolean",
            "default": false,
            "description": "Keep subscription active until end date"
          },
          "reason": {
            "type": "string",
            "example": "user_cancelled",
            "description": "Cancellation reason"
          }
        }
      },
      "SubscriptionPurchase": {
        "type": "object",
        "required": [
          "id",
          "subscription_history_id",
          "purchasable_type",
          "purchasable_id"
        ],
        "properties": {
          "id": {
            "type": "string",
            "example": "subpurch_abc123",
            "description": "Unique subscription purchase identifier"
          },
          "subscription_history_id": {
            "type": "string",
            "example": "subhist_xyz789",
            "description": "Associated subscription history record"
          },
          "purchasable_type": {
            "type": "string",
            "enum": [
              "file",
              "lesson_plan",
              "game",
              "workshop",
              "course",
              "tool"
            ],
            "example": "workshop",
            "description": "Type of content claimed"
          },
          "purchasable_id": {
            "type": "string",
            "example": "workshop_abc123",
            "description": "ID of claimed content"
          },
          "usage_tracking": {
            "type": "object",
            "nullable": true,
            "description": "Flexible JSONB usage tracking",
            "properties": {
              "monthly_claims": {
                "type": "integer",
                "example": 1,
                "description": "Number of times claimed this month"
              },
              "total_usage": {
                "type": "integer",
                "example": 5,
                "description": "Total usage count"
              },
              "last_accessed": {
                "type": "string",
                "format": "date-time",
                "description": "Last access timestamp"
              },
              "custom_metadata": {
                "type": "object",
                "description": "Additional custom tracking data"
              }
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "SubscriptionListResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Subscription"
            }
          },
          "pagination": {
            "type": "object",
            "properties": {
              "total": {
                "type": "integer"
              },
              "page": {
                "type": "integer"
              },
              "limit": {
                "type": "integer"
              },
              "totalPages": {
                "type": "integer"
              }
            }
          }
        }
      },
      "EntityTypesResponse": {
        "type": "object",
        "properties": {
          "entityTypes": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "description": {
                  "type": "string"
                }
              }
            }
          }
        }
      },
      "ProductsListResponse": {
        "$ref": "#/components/schemas/ProductListResponse"
      },
      "ProductDetailsResponse": {
        "$ref": "#/components/schemas/ProductWithAccess"
      }
    }
  },
  "security": [
    {
      "cookieAuth": []
    },
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/auth/register": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Register new user account",
        "description": "Create a new teacher or student account with email and password",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RegisterRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "User registered successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthResponse"
                }
              }
            }
          },
          "400": {
            "description": "Validation error or user already exists",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/login/firebase": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Login with Firebase ID token",
        "description": "Authenticate using Firebase ID token from frontend Firebase Auth",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/FirebaseLoginRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login successful",
            "headers": {
              "Set-Cookie": {
                "description": "HttpOnly auth cookie",
                "schema": {
                  "type": "string"
                }
              }
            },
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthResponse"
                }
              }
            }
          },
          "401": {
            "description": "Invalid Firebase token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/student-portal": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Access student portal",
        "description": "Get student portal access via lobby code, session ID, or teacher invitation",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/StudentAccessRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Student portal access granted",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/StudentPortalAuthResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid access code or missing parameters",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "Access code not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/link-teacher": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Link student to teacher",
        "description": "Connect student account to teacher using invitation code (creates parent consent)",
        "security": [
          {
            "cookieAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TeacherInviteLinkRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successfully linked to teacher",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TeacherInviteLinkResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid invitation code",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "401": {
            "description": "User not authenticated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded (3 attempts per 15 minutes)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/refresh": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Refresh access token",
        "description": "Get new access token using refresh token",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RefreshTokenRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Token refreshed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RefreshTokenResponse"
                }
              }
            }
          },
          "401": {
            "description": "Invalid or expired refresh token",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/logout": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Logout user",
        "description": "Invalidate user session and clear auth cookie",
        "security": [
          {
            "cookieAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Logged out successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LogoutResponse"
                }
              }
            }
          },
          "401": {
            "description": "Not authenticated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/me": {
      "get": {
        "tags": [
          "Authentication"
        ],
        "summary": "Get current user",
        "description": "Retrieve current authenticated user information",
        "security": [
          {
            "cookieAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Current user information",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/User"
                }
              }
            }
          },
          "401": {
            "description": "Not authenticated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/auth/validate-session": {
      "get": {
        "tags": [
          "Authentication"
        ],
        "summary": "Validate current session",
        "description": "Check if current session is valid and return user data",
        "security": [
          {
            "cookieAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Session validation result",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SessionValidationResponse"
                }
              }
            }
          }
        }
      }
    },
    "/entities": {
      "get": {
        "tags": [
          "Entities"
        ],
        "summary": "List available entity types",
        "description": "Returns information about available entity types in the system",
        "responses": {
          "200": {
            "description": "Entity types information",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityTypesResponse"
                }
              }
            }
          }
        }
      }
    },
    "/entities/products/list": {
      "get": {
        "tags": [
          "Products"
        ],
        "summary": "List products with filtering and pagination",
        "description": "Retrieve paginated list of products with optional filtering by category, type, and search",
        "parameters": [
          {
            "name": "page",
            "in": "query",
            "description": "Page number (1-based)",
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "Items per page",
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100,
              "default": 20
            }
          },
          {
            "name": "search",
            "in": "query",
            "description": "Search term for title/description",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "category",
            "in": "query",
            "description": "Filter by category",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "product_type",
            "in": "query",
            "description": "Filter by product type",
            "schema": {
              "type": "string",
              "enum": [
                "file",
                "game",
                "workshop",
                "course",
                "tool",
                "lesson_plan",
                "bundle"
              ]
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Products list with pagination",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ProductsListResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid query parameters",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/entities/product/{id}/details": {
      "get": {
        "tags": [
          "Products"
        ],
        "summary": "Get product details with access information",
        "description": "Retrieve detailed product information including access control status",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "Product ID",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Product details with access information",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ProductDetailsResponse"
                }
              }
            }
          },
          "404": {
            "description": "Product not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "tags": []
}