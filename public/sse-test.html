<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Test - Direct EventSource</title>
</head>
<body>
    <h1>Direct EventSource Test</h1>
    <div id="status">Connecting...</div>
    <div id="events"></div>

    <script>
        const statusEl = document.getElementById('status');
        const eventsEl = document.getElementById('events');

        function log(message) {
            console.log(message);
            const div = document.createElement('div');
            div.textContent = `${new Date().toISOString()}: ${message}`;
            eventsEl.appendChild(div);
        }

        function testEventSource() {
            log('ðŸš€ Creating EventSource connection...');

            const url = 'http://localhost:3003/api/sse/events?channels=lobby:visible_games&is_lobby_owner=true&priority_hint=lobby_status';
            log(`ðŸ”— URL: ${url}`);

            const eventSource = new EventSource(url);

            eventSource.onopen = function() {
                log('âœ… EventSource opened!');
                statusEl.textContent = 'Connected';
                statusEl.style.color = 'green';
            };

            eventSource.onmessage = function(event) {
                log(`ðŸ“¨ Message received: ${event.data}`);
            };

            eventSource.onerror = function() {
                log(`âŒ EventSource error - readyState: ${eventSource.readyState}`);
                statusEl.textContent = 'Error';
                statusEl.style.color = 'red';

                if (eventSource.readyState === EventSource.CLOSED) {
                    log('ðŸ”Œ EventSource closed');
                }
            };

            // Monitor connection state
            const monitor = setInterval(() => {
                log(`ðŸ“Š EventSource state: ${eventSource.readyState} (${
                    eventSource.readyState === 0 ? 'CONNECTING' :
                    eventSource.readyState === 1 ? 'OPEN' :
                    eventSource.readyState === 2 ? 'CLOSED' : 'UNKNOWN'
                })`);

                if (eventSource.readyState === 2) {
                    clearInterval(monitor);
                    log('ðŸ›‘ Monitoring stopped - connection closed');
                }
            }, 1000);

            // Cleanup button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close Connection';
            closeBtn.onclick = () => {
                log('ðŸ”Œ Manually closing EventSource');
                eventSource.close();
                clearInterval(monitor);
            };
            document.body.appendChild(closeBtn);

            return eventSource;
        }

        // Start the test
        testEventSource();
    </script>
</body>
</html>